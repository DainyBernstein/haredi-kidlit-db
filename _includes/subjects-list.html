{% assign role_map = 
  "publisher:Publisher;
   publisher2:Imprint / Sponsor;
   distributor:Distributor" | split:";" %}

{% assign target = include.page %}
{% assign all_terms = "" | split: "|" %}
{% assign fields = include.fields | split: ";" %}

{%- comment -%} Collect all values from all specified fields and label with role {%- endcomment -%}
{% for item in site.data[site.metadata] %}
  {% for field in fields %}
    {% assign values = item[field] | split: ";" %}
    {% for val in values %}
      {% assign clean = val | strip %}
      {% if clean != "" %}
        {% assign entry = field | append: "::" | append: clean %}
        {% assign all_terms = all_terms | push: entry %}
      {% endif %}
    {% endfor %}
  {% endfor %}
{% endfor %}

{%- comment -%} Unique + alphabetical {%- endcomment -%}
{% assign terms = all_terms | uniq | sort %}

{%- comment -%} Build set of starting letters A–Z {%- endcomment -%}
{% assign letters = "" | split: "|" %}
{% for term in terms %}
  {% assign parts = term | split: "::" %}
  {% assign role = parts[0] %}
  {% assign name = parts[1] %}
  {% assign role_label = role %}
  {% for r in role_map %}
    {% assign pair = r | split: ":" %}
    {% if pair[0] == role %}
      {% assign role_label = pair[1] %}
    {% endif %}
  {% endfor %}
  {% assign first = name | slice: 0,1 | upcase %}
  {% assign letters = letters | push: first %}
{% endfor %}
{% assign letters = letters | uniq | sort %}

{%- comment -%} A–Z navigation bar {%- endcomment -%}
<nav class="mb-3">
  {% for l in letters %}
    <a href="#letter-{{ l }}" class="me-2">{{ l }}</a>
  {% endfor %}
</nav>

<ul class="list-unstyled">

{% assign current_letter = "" %}

{% for term in terms %}
  {% assign parts = term | split: "::" %}
  {% assign role = parts[0] %}
  {% assign name = parts[1] %}
  {% assign role_label = role %}
  {% for r in role_map %}
    {% assign pair = r | split: ":" %}
    {% if pair[0] == role %}
      {% assign role_label = pair[1] %}
    {% endif %}
  {% endfor %}

  {% assign first_letter = name | slice: 0,1 | upcase %}

  {%- comment -%} Letter header {%- endcomment -%}
  {% if first_letter != current_letter %}
    {% assign current_letter = first_letter %}
    <li id="letter-{{ current_letter }}">
      <strong>{{ current_letter }}</strong>
    </li>
  {% endif %}

  {%- comment -%} Count occurrences {%- endcomment -%}
  {% assign count = 0 %}
  {% for item in site.data[site.metadata] %}
    {% for field in fields %}
      {% if item[field] contains name %}
        {% assign count = count | plus: 1 %}
        {% break %}
      {% endif %}
    {% endfor %}
  {% endfor %}

  <li class="ms-3">
   <a href="{{ target | relative_url }}#{{ name | uri_escape }}">
  {{ name }}
  <small class="text-muted">({{ role_label }})</small>
  <span class="text-muted">({{ count }})</span>
</a>

  </li>

{% endfor %}

</ul>
